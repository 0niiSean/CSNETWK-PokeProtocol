# ðŸ“¦ PokeProtocol Message Specifications (The Language)

[cite_start]All communication uses **UDP datagrams**[cite: 25, 26]. [cite_start]Each datagram MUST contain exactly **one message** in a simple, plain text format[cite: 42].

---

## 1. Universal Message Format
Every message is composed of required and optional fields as newline-separated key:value pairs. [cite_start]The field **`message_type` is mandatory** for all messages[cite: 43].

### A. Required Base Fields
These fields MUST be present in all messages related to battle flow (i.e., everything except generic ACKs).

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `ATTACK_ANNOUNCE` | Defines the purpose of the message. [cite_start]| [cite: 43] |
| `sequence_number` | `15` | Unique, monotonically increasing number for reliability. [cite_start]| [cite: 81, 184] |

### B. Acknowledgment (ACK) Message Structure

[cite_start]This special message is sent to confirm receipt of a message with a specific `sequence_number`[cite: 185]. It does not need its own `sequence_number`.

| Key | Example Value | Description |
| :--- | :--- | :--- |
| `message_type` | `ACK` | Signals that this is solely an acknowledgment. |
| `ack_number` | `15` | The sequence number of the message being acknowledged. |

<blockquote>
**Example:** Peer A receives a message with `sequence_number: 15`. Peer A immediately sends back:
<pre>message_type: ACK
ack_number: 15</pre>
</blockquote>

## 2. Turn Synchronization Messages (The Handshake)

This sequence ensures atomic turn processing:

### 2.1. ATTACK_ANNOUNCE (Step 1: Announce)
[cite_start]Sent by the acting peer to announce their chosen move[cite: 77].

| Key | Example Value | Description |
| :--- | :--- | :--- |
| `message_type` | `ATTACK_ANNOUNCE` | Required. |
| `sequence_number` | `5` | Required for reliability. |
| **`move_name`** | `Thunderbolt` | [cite_start]**The key data**: Name of the move chosen[cite: 80, 84]. |
| **`use_special_boost`** | `FALSE` | NEW: Boolean (TRUE/FALSE) indicating use of a limited-use stat_boost this turn. |

---

### 2.2. DEFENSE_ANNOUNCE (Step 2: Defend)
[cite_start]Sent by the defending peer to acknowledge the opponent's move and signal readiness[cite: 87].

| Key | Example Value | Description |
| :--- | :--- | :--- |
| `message_type` | `DEFENSE_ANNOUNCE` | Required. |
| `sequence_number` | `6` | Required for reliability. |

---

### 2.3. CALCULATION_REPORT (Step 3: Report/Checksum)
[cite_start]**Crucial for synchronization.** Both players calculate the damage *independently* and send this report as a "checksum"[cite: 94, 207].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `CALCULATION_REPORT` | Required. [cite_start]| [cite: 95] |
| `sequence_number` | `7` | Required for reliability. [cite_start]| [cite: 104] |
| **`damage_dealt`** | `80` | [cite_start]The core value: Damage calculated by the sender[cite: 99]. [cite_start]| [cite: 99] |
| **`defender_hp_remaining`** | `20` | [cite_start]The resulting HP of the defender after damage[cite: 101, 112]. [cite_start]| [cite: 101] |
| `status_message` | `It was super effective!` | [cite_start]A flavor text message summarizing the turn[cite: 103, 113]. [cite_start]| [cite: 103] |

>
**Integrity Check:** Upon receiving the `CALCULATION_REPORT`, the peer **MUST** compare the received `damage_dealt` and `defender_hp_remaining` against their locally calculated values.

---

### 2.4. CALCULATION_CONFIRM (Step 4: Confirm)
[cite_start]Sent when the calculation report matches the local result, confirming state agreement[cite: 115]. [cite_start]If it doesn't match, the peer sends a `RESOLUTION_REQUEST`[cite: 121, 212].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `CALCULATION_CONFIRM` | Required. [cite_start]| [cite: 116] |
| `sequence_number` | `8` | Required for reliability. [cite_start]| [cite: 117] |

## 3. Initial Setup Message

### 3.1. BATTLE_SETUP
[cite_start]Sent by both playing peers after the initial connection handshake to define the initial state[cite: 62].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `BATTLE_SETUP` | Required. [cite_start]| [cite: 64] |
| **`seed`** | `12345` | [cite_start]**Crucial for synchronization.** Random integer generated by the Host and shared in the `HANDSHAKE_RESPONSE`[cite: 52, 192, 193]. [cite_start]| [cite: 52] |
| `pokemon_name` | `Pikachu` | [cite_start]The name of the player's chosen PokÃ©mon[cite: 68]. [cite_start]| [cite: 68] |
| **`stat_boosts`** | `{ "sp_atk_uses": 5, "sp_def_uses": 5 }` | [cite_start]Player's initial allocation of limited-use boosts[cite: 69]. [cite_start]**The Game Master (Person C) must define the exact names/format.** | [cite: 69] |

## 3. Initial Setup Messages (Continued)

### 3.2. HANDSHAKE_REQUEST
[cite_start]This message is sent by the Joiner Peer to initiate a logical connection as a playing peer[cite: 45].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `HANDSHAKE_REQUEST` | Required. [cite_start]| [cite: 47] |

---

### 3.3. SPECTATOR_REQUEST
[cite_start]This message is sent by a peer to initiate a logical connection as a spectator[cite: 58].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `SPECTATOR_REQUEST` | Required. [cite_start]| [cite: 60] |

---

### 3.4. HANDSHAKE_RESPONSE
[cite_start]This message is sent by the Host Peer to acknowledge a connection request[cite: 49].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `HANDSHAKE_RESPONSE` | Required. [cite_start]| [cite: 51] |
| **`seed`** | `12345` | [cite_start]**Crucial for synchronization.** A random integer that will be used to seed the random number generator on both peers[cite: 52, 56]. [cite_start]| [cite: 52] |

---

## 4. Reliability Layer (Making UDP Safe)

[cite_start]The reliability layer uses **Sequence Numbers**, **ACKs**, and **Retransmissions** to handle lost packets, ensuring the Battle State remains synchronized[cite: 6, 14].

### 4.1. The ACK Rule
[cite_start]Every single message carrying a `sequence_number` (i.e., every battle and chat message) **MUST** trigger an immediate response from the receiver: an `ACK` message carrying the corresponding `ack_number`.

> **Easy Rule:** If you see a `sequence_number`, send back an `ACK`.

## 4. Reliability Layer (Making UDP Safe)

[cite_start]The reliability layer uses **Sequence Numbers**, **ACKs**, and **Retransmissions** to handle lost packets, ensuring the Battle State remains synchronized[cite: 6, 14].

### 4.1. The ACK Rule
[cite_start]Every single message carrying a `sequence_number` (i.e., every battle and chat message) **MUST** trigger an immediate response from the receiver: an `ACK` message carrying the corresponding `ack_number`.

> **Easy Rule:** If you see a `sequence_number`, send back an `ACK`.

## 5. Game Flow and State Machine

[cite_start]The battle follows a simple, turn-based state machine[cite: 180].

### 5.1. Protocol States

| State Name | Peer Role | Description | Trigger |
| :--- | :--- | :--- | :--- |
| **INITIAL** | Host/Joiner | [cite_start]Waiting for connection requests[cite: 191]. | Connection established. |
| **SETUP** | Host/Joiner | [cite_start]Exchanging the initial game data (PokÃ©mon, seed, boosts)[cite: 191, 194]. | `BATTLE_SETUP` exchange complete. |
| **WAITING_FOR_MOVE** | Host/Joiner | Normal state. [cite_start]One peer is waiting for the other's `ATTACK_ANNOUNCE`[cite: 195, 197, 210]. | `CALCULATION_CONFIRM` received (turn reverses). |
| **PROCESSING_TURN**| Host/Joiner | [cite_start]Both peers have submitted their move and are resolving the turn (calculating damage and verifying results)[cite: 204, 205]. | `ATTACK_ANNOUNCE` and `DEFENSE_ANNOUNCE` exchanged. |
| **GAME_OVER** | Host/Joiner/Spectator | [cite_start]Battle has ended due to a PokÃ©mon fainting[cite: 222, 225]. | `GAME_OVER` message received. |

### 5.2. The 4-Step Turn Cycle (WAITING_FOR_MOVE $\leftrightarrow$ PROCESSING_TURN)

[cite_start]The battle alternates turns, starting with the **Host Peer**[cite: 198].

| Step | Current State | Peer Action | Message Sent | Next State |
| :--- | :--- | :--- | :--- | :--- |
| **Turn Start** | WAITING_FOR_MOVE | Acting peer chooses move. | [cite_start]**ATTACK_ANNOUNCE** [cite: 199] | WAITING_FOR_MOVE (Defender remains in WAITING) |
| **Acknowledge Move** | WAITING_FOR_MOVE | Defending peer receives `ATTACK_ANNOUNCE`. | [cite_start]**DEFENSE_ANNOUNCE** [cite: 202] | [cite_start]PROCESSING_TURN (Both peers enter this state) [cite: 204] |
| **Verify Calculation** | PROCESSING_TURN | Both peers independently calculate damage. | [cite_start]**CALCULATION_REPORT** [cite: 207, 208] | PROCESSING_TURN (Waiting for opponent's report) |
| **Agree on State** | PROCESSING_TURN | Both peers agree the two `CALCULATION_REPORT`s match. | [cite_start]**CALCULATION_CONFIRM** [cite: 210] | [cite_start]WAITING_FOR_MOVE (Turn ownership reverses) [cite: 210] |

---

#### Step 5: Detail Error Handling (Discrepancy Resolution) ðŸ›‘

You must define the exact actions when the "checksum" (the `CALCULATION_REPORT`) fails. [cite_start]This is crucial for **Discrepancy Resolution** (10 points on rubric)[cite: 327].

* **Action:** Document the two outcomes of checking the `CALCULATION_REPORT`.
* **Content:**

```markdown
### 5.3. Discrepancy Resolution Logic

During the **PROCESSING_TURN** state, when Peer A receives Peer B's `CALCULATION_REPORT`:

* **Success (Match):** If Peer B's reported damage and HP match Peer A's local calculation, Peer A sends a **`CALCULATION_CONFIRM`**[cite: 210]. The turn concludes, and ownership reverses.
* **Failure (Mismatch):** If Peer B's report **does not match** Peer A's local calculation, Peer A **MUST** send a **`RESOLUTION_REQUEST`** containing its locally calculated values[cite: 212].
    * The peer receiving the `RESOLUTION_REQUEST` must re-evaluate the turn based on the sender's values[cite: 213]. If they agree, they send an ACK and update their state to match[cite: 214]. If they *still* disagree, the battle **SHOULD** terminate due to a fundamental error[cite: 215].

    ## 6. Terminal and Error Messages

### 6.1. GAME_OVER
[cite_start]This message is sent by a player when their opponent's PokÃ©mon has fainted[cite: 140, 223].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `GAME_OVER` | Required. [cite_start]| [cite: 142] |
| `sequence_number` | `10` | [cite_start]Required for reliability[cite: 146, 224]. [cite_start]| [cite: 146] |
| `winner` | `Pikachu` | [cite_start]The name of the PokÃ©mon that won[cite: 143, 148]. [cite_start]| [cite: 143] |
| `loser` | `Charmander` | [cite_start]The name of the PokÃ©mon that fainted[cite: 145, 149]. [cite_start]| [cite: 145] |

---

### 6.2. RESOLUTION_REQUEST
[cite_start]This message is sent by a player when a calculation discrepancy is detected[cite: 121].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `RESOLUTION_REQUEST` | Required. [cite_start]| [cite: 123] |
| `sequence_number` | `9` | [cite_start]Required for reliability[cite: 131]. [cite_start]| [cite: 131] |
| `attacker` | `Pikachu` | [cite_start]The name of the PokÃ©mon that attacked[cite: 124, 134]. [cite_start]| [cite: 124] |
| `move_used` | `Thunderbolt` | [cite_start]The name of the move that was used[cite: 125, 135]. [cite_start]| [cite: 125] |
| `damage_dealt` | `80` | [cite_start]The damage inflicted as calculated by the sending peer[cite: 127, 128, 136]. [cite_start]| [cite: 128] |
| `defender_hp_remaining`| `20` | [cite_start]The defender's remaining HP as calculated by the sending peer[cite: 129, 130, 137]. [cite_start]| [cite: 130] |

---

## 7. Asynchronous Communication (Chat and Stickers)

### 7.1. CHAT_MESSAGE
This message is used for sending a plain text chat message or a sticker between peers. [cite_start]It can be sent at any time, independently of the turn-based battle logic[cite: 152, 153].

| Key | Example Value | Description | Source |
| :--- | :--- | :--- | :--- |
| `message_type` | `CHAT_MESSAGE` | Required. [cite_start]| [cite: 154] |
| `sequence_number` | `11` | [cite_start]Required for reliability[cite: 164]. [cite_start]| [cite: 164] |
| `sender_name` | `Player1` | [cite_start]The name of the peer sending the message[cite: 155, 169]. [cite_start]| [cite: 155] |
| **`content_type`** | `TEXT` or `STICKER` | [cite_start]A string that specifies the content type of the message[cite: 157, 158, 170]. [cite_start]| [cite: 158] |
| `message_text` | `Good luck, have fun!` | (Optional) [cite_start]The content of the chat message, used when `content_type` is `TEXT`[cite: 159, 171]. [cite_start]| [cite: 159] |
| `sticker_data` | `iVBORw0KGgoAAA...` | (Optional) [cite_start]A Base64 encoded string of the sticker data, used when `content_type` is `STICKER`[cite: 160, 177]. [cite_start]| [cite: 160] |

> [cite_start]**IMPORTANT:** Chat messages still require an **ACK** to ensure they are reliably delivered[cite: 221].

---

### Step 6: Define Reliability Parameters (Completing Section 4)

Finally, let's complete the Reliability Section by adding the mandatory retransmission parameters.

* **Action:** Add the detailed retransmission logic to your Section 4.
* **Content (Integrating into Section 4.2):**

```markdown
### 4.2. Retransmission Logic
When a critical message is sent, the sender starts a timer. [cite_start]If the corresponding ACK is not received before the timer expires, the original message must be sent again (retransmission)[cite: 186].

| Parameter | Recommended Value | Peer Action | Source |
| :--- | :--- | :--- | :--- |
| **Timeout** | **500 milliseconds (0.5s)** | [cite_start]Sender waits this long for an ACK before retransmitting[cite: 188]. [cite_start]| [cite: 188] |
| **Max Retries** | **3** | [cite_start]The maximum number of times a peer can retransmit a message[cite: 189]. [cite_start]| [cite: 189] |

> [cite_start]**Hard Rule:** If the sender reaches the **Max Retries** (sends the message 4 times total: 1 original + 3 retries) and still receives no ACK, the peer **SHOULD** assume the connection is lost and terminate the battle[cite: 187].